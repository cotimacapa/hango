{% load static i18n %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'pt-br' }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Hango{% endblock %}</title>

    <script>
      (function () {
        const KEY = 'hango:theme';
        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (_) {}
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = (saved === 'auto')
          ? (prefersDark ? 'dark' : 'light')
          : (saved || (prefersDark ? 'dark' : 'light'));
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>

    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="{% if request.user.is_authenticated %}{% url 'menu:list' %}{% else %}/{% endif %}">
          üçΩÔ∏è Hango
        </a>

        <a class="navbar-item theme-toggle is-hidden-desktop" role="button" aria-label="{% trans "Theme" %}" title="{% trans "Theme" %}">
          <span class="js-theme-icon" aria-hidden="true"></span>
        </a>

        <form action="{% url 'set_language' %}" method="post"
              class="navbar-item lang-nav p-0 m-0 is-hidden-desktop">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <div class="buttons has-addons">
            <button type="submit" name="language" value="pt-br"
                    class="button is-small {% if LANGUAGE_CODE|slice:':2' == 'pt' %}is-primary{% else %}is-light{% endif %}">
              PT-BR
            </button>
            <button type="submit" name="language" value="en"
                    class="button is-small {% if LANGUAGE_CODE == 'en' %}is-primary{% else %}is-light{% endif %}">
              EN
            </button>
          </div>
        </form>

        {% if request.user.is_authenticated %}
          <button class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="mainNav" type="button">
            <span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span>
          </button>
        {% endif %}
      </div>

      <div id="mainNav" class="navbar-menu">
        <div class="navbar-start">
          {% if request.user.is_authenticated %}
            <span class="navbar-item is-static">
              {% trans "Hello" %}, {{ request.user.first_name|default:request.user.username }}
            </span>

            <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'cart' %}is-active{% endif %}"
              href="{% url 'orders:cart' %}">
              {% trans "Cart" %} ({{ cart_count }})
            </a>

            {% if request.user.is_staff %}
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'kitchen' %}is-active{% endif %}"
                href="{% url 'orders:kitchen' %}">
                {% trans "Kitchen" %}
              </a>

              <!-- üîπ New Orders link -->
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'list' %}is-active{% endif %}"
                href="{% url 'orders:list' %}">
                {% trans "Orders" %}
              </a>

              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'admin' %}is-active{% endif %}"
                href="{% url 'admin:index' %}">
                {% trans "Admin" %}
              </a>
            {% endif %}
          {% endif %}
        </div>

        <div class="navbar-end">
          <a class="navbar-item theme-toggle is-hidden-touch" role="button" aria-label="{% trans "Theme" %}" title="{% trans "Theme" %}">
            <span class="js-theme-icon" aria-hidden="true"></span>
          </a>

          <a class="navbar-item {% if request.resolver_match and request.resolver_match.url_name == 'about' %}is-active{% endif %}"
            href="{% url 'about' %}">
            {% trans "About Hango" %}
          </a>

          {% if request.user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}" class="navbar-item logout-form">
              {% csrf_token %}<input type="hidden" name="next" value="/" />
              <button type="submit" class="logout-button">{% trans "Log out" %}</button>
            </form>
          {% endif %}

          <form action="{% url 'set_language' %}" method="post"
                class="navbar-item p-0 m-0 lang-nav is-hidden-touch">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <div class="buttons has-addons">
              <button type="submit" name="language" value="pt-br"
                      class="button is-small {% if LANGUAGE_CODE|slice:':2' == 'pt' %}is-primary{% else %}is-light{% endif %}">
                PT-BR
              </button>
              <button type="submit" name="language" value="en"
                      class="button is-small {% if LANGUAGE_CODE == 'en' %}is-primary{% else %}is-light{% endif %}">
                EN
              </button>
            </div>
          </form>
        </div>
      </div>
    </nav>

    <section class="section"><div class="container">

      {# Flash messages: iterate (consumes the queue) and auto-dismiss #}
      {% if messages %}
        <div id="flash-stack" class="mt-3">
          {% for message in messages %}
            <div class="notification is-info flash-msg" role="status" aria-live="polite">
              {{ message }}
              <button class="delete" aria-label="{% trans 'Dismiss' %}"></button>
            </div>
          {% endfor %}
        </div>
        <script>
          (function () {
            const msgs = document.querySelectorAll('.flash-msg');
            msgs.forEach((el, i) => {
              const btn = el.querySelector('.delete');
              if (btn) btn.addEventListener('click', () => el.remove());
              const delay = 3000 + (i * 400);
              setTimeout(() => {
                el.style.transition = 'opacity .35s ease, transform .35s ease';
                el.style.opacity = '0';
                el.style.transform = 'translateY(-6px)';
                setTimeout(() => el.remove(), 380);
              }, delay);
            });
          })();
        </script>
      {% endif %}

      {% block content %}{% endblock %}
    </div></section>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.navbar-burger').forEach(burger => {
          burger.addEventListener('click', () => {
            const targetId = burger.dataset.target;
            const target = targetId ? document.getElementById(targetId) : null;

            burger.classList.toggle('is-active');
            if (target) target.classList.toggle('is-active');

            const expanded = burger.getAttribute('aria-expanded') === 'true';
            burger.setAttribute('aria-expanded', String(!expanded));
          });
        });
      });

      (function () {
        const KEY = 'hango:theme';
        const STATES = ['light', 'dark', 'auto'];
        const btns  = document.querySelectorAll('.theme-toggle');
        const icons = document.querySelectorAll('.theme-toggle .js-theme-icon');

        const MOON = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" fill="currentColor"/></svg>';
        const SUN  = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/><g stroke="currentColor" stroke-width="2"><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12"/><path d="M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></g></svg>';
        const SYSTEM = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 5 A7 7 0 1 1 12 19 Z" fill="currentColor"/><path d="M12 5 L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';

        const osMedia = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        const label = (s) => s === 'auto' ? 'System' : (s === 'dark' ? 'Dark' : 'Light');
        const next  = (s) => STATES[(STATES.indexOf(s) + 1) % STATES.length];
        const effective = (s) => s === 'auto' ? (osMedia && osMedia.matches ? 'dark' : 'light') : s;

        function paint(state) {
          const eff = effective(state);
          document.documentElement.setAttribute('data-theme', eff);
          try { localStorage.setItem(KEY, state); } catch (_) {}
          icons.forEach(el => el.innerHTML = state === 'auto' ? SYSTEM : (eff === 'dark' ? SUN : MOON));
          btns.forEach(el => {
            const t = '{% trans "Theme" %}: ' + (state === 'auto' ? 'System' : (state === 'dark' ? 'Dark' : 'Light'));
            el.title = t; el.setAttribute('aria-label', t);
          });
        }

        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (_) {}
        if (!saved) saved = 'auto';
        paint(saved);

        if (osMedia) {
          osMedia.addEventListener('change', () => {
            try {
              if ((localStorage.getItem(KEY) || 'auto') === 'auto') paint('auto');
            } catch (_) { paint('auto'); }
          });
        }

        btns.forEach(btn => btn.addEventListener('click', () => {
          let cur = 'auto';
          try { cur = localStorage.getItem(KEY) || 'auto'; } catch (_) {}
          paint(next(cur));
        }));
      })();
    </script>
  </body>
</html>
