{% load static i18n %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'pt-br' }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Hango{% endblock %}</title>

    <script>
      (function () {
        const KEY = 'hango:theme';
        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (_) {}
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = (saved === 'auto')
          ? (prefersDark ? 'dark' : 'light')
          : (saved || (prefersDark ? 'dark' : 'light'));
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>

    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        {# Logo: /menu/ if signed in, splash if not #}
        <a class="navbar-item" href="{% if request.user.is_authenticated %}{% url 'menu:list' %}{% else %}/{% endif %}">
          üçΩÔ∏è Hango
        </a>

        {# {% trans "Theme" %} toggle (mobile/tablet, always visible) #}
        <a class="navbar-item theme-toggle is-hidden-desktop" role="button" aria-label="{% trans "Theme" %}" title="{% trans "Theme" %}">
          <span class="js-theme-icon" aria-hidden="true"></span>
        </a>

        {# NEW: Language switch next to theme toggle on mobile (always, logged-in or not) #}
        <form action="{% url 'set_language' %}" method="post"
              class="navbar-item lang-nav p-0 m-0 is-hidden-desktop">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <div class="buttons has-addons">
            <button type="submit" name="language" value="pt-br"
                    class="button is-small {% if LANGUAGE_CODE|slice:':2' == 'pt' %}is-primary{% else %}is-light{% endif %}">
              PT-BR
            </button>
            <button type="submit" name="language" value="en"
                    class="button is-small {% if LANGUAGE_CODE == 'en' %}is-primary{% else %}is-light{% endif %}">
              EN
            </button>
          </div>
        </form>

        {# Show burger only when a user is signed in (so there‚Äôs something to open) #}
        {% if request.user.is_authenticated %}
          <button class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="mainNav" type="button">
            <span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span>
          </button>
        {% endif %}
      </div>

      <div id="mainNav" class="navbar-menu">
        <!-- LEFT side (after logo): Hello, Cart, [Kitchen, {% trans "Admin" %} for staff] -->
        <div class="navbar-start">
          {% if request.user.is_authenticated %}
            <span class="navbar-item is-static">
              {% trans "Hello" %}, {{ request.user.first_name|default:request.user.username }}
            </span>

            <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'cart' %}is-active{% endif %}"
              href="{% url 'orders:cart' %}">
              {% trans "Cart" %} ({{ cart_count }})
            </a>

            {% if request.user.is_staff %}
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'kitchen' %}is-active{% endif %}"
                href="{% url 'orders:kitchen' %}">
                {% trans "Kitchen" %}
              </a>

              {# Use the admin named URL so ‚Äúactive‚Äù works reliably #}
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'admin' %}is-active{% endif %}"
                href="{% url 'admin:index' %}">
                {% trans "Admin" %}
              </a>
            {% endif %}
          {% endif %}
        </div>

        <!-- RIGHT edge: {% trans "Theme" %} ‚Üí About ‚Üí Log out ‚Üí (Desktop) Language -->
        <div class="navbar-end">
          <!-- {% trans "Theme" %} toggle (desktop only) -->
          <a class="navbar-item theme-toggle is-hidden-touch" role="button" aria-label="{% trans "Theme" %}" title="{% trans "Theme" %}">
            <span class="js-theme-icon" aria-hidden="true"></span>
          </a>

          <a class="navbar-item {% if request.resolver_match and request.resolver_match.url_name == 'about' %}is-active{% endif %}"
            href="{% url 'about' %}">
            {% trans "About Hango" %}
          </a>

          {% if request.user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}" class="navbar-item logout-form">
              {% csrf_token %}<input type="hidden" name="next" value="/" />
              <button type="submit" class="logout-button">{% trans "Log out" %}</button>
            </form>
          {% endif %}

          {# Desktop language switch (hide on touch) #}
          <form action="{% url 'set_language' %}" method="post"
                class="navbar-item p-0 m-0 lang-nav is-hidden-touch">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <div class="buttons has-addons">
              <button type="submit" name="language" value="pt-br"
                      class="button is-small {% if LANGUAGE_CODE|slice:':2' == 'pt' %}is-primary{% else %}is-light{% endif %}">
                PT-BR
              </button>
              <button type="submit" name="language" value="en"
                      class="button is-small {% if LANGUAGE_CODE == 'en' %}is-primary{% else %}is-light{% endif %}">
                EN
              </button>
            </div>
          </form>
        </div>
      </div>
    </nav>

    <section class="section"><div class="container">
      {% for message in messages %}<div class="notification is-info">{{ message }}</div>{% endfor %}
      {% block content %}{% endblock %}
    </div></section>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // BULMA burger: toggle .is-active on both the button and its target
        document.querySelectorAll('.navbar-burger').forEach(burger => {
          burger.addEventListener('click', () => {
            const targetId = burger.dataset.target;
            const target = targetId ? document.getElementById(targetId) : null;

            burger.classList.toggle('is-active');
            if (target) target.classList.toggle('is-active');

            // A11y: reflect state
            const expanded = burger.getAttribute('aria-expanded') === 'true';
            burger.setAttribute('aria-expanded', String(!expanded));
          });
        });
      });

      // Three-state theme toggle (light ‚Üî dark ‚Üî system), supports multiple buttons
      (function () {
        const KEY = 'hango:theme';
        const STATES = ['light', 'dark', 'auto']; // "auto" follows OS
        const btns  = document.querySelectorAll('.theme-toggle');
        const icons = document.querySelectorAll('.theme-toggle .js-theme-icon');

        const MOON = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" fill="currentColor"/></svg>';
        const SUN  = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/><g stroke="currentColor" stroke-width="2"><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12"/><path d="M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></g></svg>';
        const SYSTEM = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 5 A7 7 0 1 1 12 19 Z" fill="currentColor"/><path d="M12 5 L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';

        const osMedia = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        const label = (s) => s === 'auto' ? 'System' : (s === 'dark' ? 'Dark' : 'Light');
        const next  = (s) => STATES[(STATES.indexOf(s) + 1) % STATES.length];
        const effective = (s) => s === 'auto' ? (osMedia && osMedia.matches ? 'dark' : 'light') : s;

        function paint(state) {
          const eff = effective(state);
          document.documentElement.setAttribute('data-theme', eff);
          try { localStorage.setItem(KEY, state); } catch (_) {}
          icons.forEach(el => el.innerHTML = state === 'auto' ? SYSTEM : (eff === 'dark' ? SUN : MOON));
          btns.forEach(el => {
            const t = '{% trans "Theme" %}: ' + label(state);
            el.title = t; el.setAttribute('aria-label', t);
          });
        }

        // Initial state
        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (_) {}
        if (!saved) saved = 'auto';
        paint(saved);

        // Follow OS when in 'auto'
        if (osMedia) {
          osMedia.addEventListener('change', () => {
            const cur = (function(){ try { return localStorage.getItem(KEY); } catch(_) { return 'auto'; } })();
            if (cur === 'auto') paint('auto');
          });
        }

        // Click handlers for all toggles
        btns.forEach(btn => btn.addEventListener('click', () => {
          const cur = (function(){ try { return localStorage.getItem(KEY); } catch(_) { return 'auto'; } })() || 'auto';
          paint(next(cur));
        }));
      })();
    </script>
  </body>
</html>
