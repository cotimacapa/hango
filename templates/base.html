{% load static %}
<!DOCTYPE html>
<html lang="pt-br" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
  <head>

    <link rel="icon" type="image/svg+xml" href="{% static 'favicon/emoji-favicon.svg' %}">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mynerve&display=swap" rel="stylesheet">

    <title>{% block title %}Hango{% endblock %}</title>

    <script>
      (function () {
        const KEY = 'hango:theme';
        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (_) {}
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = (saved === 'auto')
          ? (prefersDark ? 'dark' : 'light')
          : (saved || (prefersDark ? 'dark' : 'light'));
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>

    <nav class="navbar is-primary" role="navigation" aria-label="Navega√ß√£o principal">
      <div class="navbar-brand">
        <!-- Logo: ALWAYS go to "/" -->
        <!-- <a class="navbar-item brand-wordmark" href="/">
          üçΩÔ∏è Hango
        </a> -->
        <a href="{% url 'home' %}" class="navbar-item">
          <span class="brand-wordmark">
          üçΩÔ∏è Hango
          </span>
        </a>
        <a class="navbar-item theme-toggle is-hidden-desktop" role="button" aria-label="Tema" title="Tema">
          <span class="js-theme-icon" aria-hidden="true"></span>
        </a>

        <!-- Burger visible for everyone -->
        <button class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="mainNav" type="button">
          <span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span>
        </button>
      </div>

      <div id="mainNav" class="navbar-menu">
        <div class="navbar-start">
          {% if request.user.is_authenticated %}
            <span class="navbar-item is-static">
              {{ greeting_pt }}, {{ request.user.first_name|default:request.user.username }} 
            </span>

            {# Card√°pio: only for non-staff users #}
            {% if not request.user.is_staff %}
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'menu' and request.resolver_match.url_name == 'list' %}is-active{% endif %}"
                 href="{% url 'menu:list' %}">
                Card√°pio
              </a>
            

              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'cart' %}is-active{% endif %}"
                href="{% url 'orders:cart' %}">
                Carrinho ({{ cart_count }})
              </a>

              <!-- NEW: Hist√≥rico (students only), placed immediately to the right of Carrinho -->
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'history' %}is-active{% endif %}"
                 href="{% url 'orders:history' %}">
                Hist√≥rico
              </a>
            {% endif %}
            
            {% if request.user.is_staff %}
              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'kitchen' %}is-active{% endif %}"
                 href="{% url 'orders:kitchen' %}">
                Cozinha
              </a>

              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'orders' and request.resolver_match.url_name == 'list' %}is-active{% endif %}"
                 href="{% url 'orders:list' %}">
                Pedidos
              </a>

              <a class="navbar-item {% if request.resolver_match and request.resolver_match.app_name == 'admin' %}is-active{% endif %}"
                 href="{% url 'admin:index' %}">
                Admin
              </a>
            {% endif %}
          {% endif %}
        </div>

        <div class="navbar-end">
          <a class="navbar-item theme-toggle is-hidden-touch" role="button" aria-label="Tema" title="Tema">
            <span class="js-theme-icon" aria-hidden="true"></span>
          </a>

          {% if request.user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}" class="navbar-item logout-form">
              {% csrf_token %}<input type="hidden" name="next" value="/" />
              <button type="submit" class="logout-button">Sair</button>
            </form>
          {% else %}
            <!-- Optional: keep login here if you want it in the nav for guests -->
            <div class="navbar-item is-hidden-touch">
              <a class="button is-primary" href="{% url 'login' %}?next={% url 'post_login_redirect' %}">
                Entrar
              </a>
            </div>
          {% endif %}

          <a class="navbar-item {% if request.resolver_match and request.resolver_match.url_name == 'about' %}is-active{% endif %}"
             href="{% url 'about' %}">
            Sobre o Hango
          </a>
        </div>
      </div>
    </nav>

    <section class="section"><div class="container">
      {% if messages %}
        <div id="flash-stack" class="mt-3">
          {% for message in messages %}
        <div class="notification is-{{ message.tags }} flash-msg" role="status" aria-live="polite">
              {{ message }}
              <button class="delete" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        </div>
        <script>
          (function () {
            const msgs = document.querySelectorAll('.flash-msg');
            msgs.forEach((el, i) => {
              const btn = el.querySelector('.delete');
              if (btn) btn.addEventListener('click', () => el.remove());
              const delay = 3000 + (i * 400);
              setTimeout(() => {
                el.style.transition = 'opacity .35s ease, transform .35s ease';
                el.style.opacity = '0';
                el.style.transform = 'translateY(-6px)';
                setTimeout(() => el.remove(), 380);
              }, delay);
            });
          })();
        </script>
      {% endif %}

      {% block content %}{% endblock %}
    </div></section>

    <!-- REPLACED burger script: robust click delegation -->
    <script>
      document.addEventListener('click', function (e) {
        const burger = e.target.closest('.navbar-burger');
        if (!burger) return;

        const targetId = burger.dataset.target || 'mainNav';
        const menu = document.getElementById(targetId);

        burger.classList.toggle('is-active');
        if (menu) menu.classList.toggle('is-active');

        const expanded = burger.getAttribute('aria-expanded') === 'true';
        burger.setAttribute('aria-expanded', String(!expanded));
      });
    </script>

    <script>
      (function () {
        const KEY = 'hango:theme';
        const STATES = ['light', 'dark', 'auto'];
        const btns  = document.querySelectorAll('.theme-toggle');
        const icons = document.querySelectorAll('.theme-toggle .js-theme-icon');

        const MOON = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="2" fill="currentColor"/></svg>';
        const SUN  = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/><g stroke="currentColor" stroke-width="2"><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12"/><path d="M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></g></svg>';
        const SYSTEM = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 5 A7 7 0 1 1 12 19 Z" fill="currentColor"/><path d="M12 5 L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';

        const osMedia = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        const label = (s) => s === 'auto' ? 'Sistema' : (s === 'dark' ? 'Escuro' : 'Claro');
        const next  = (s) => STATES[(STATES.indexOf(s) + 1) % STATES.length];
        const effective = (s) => s === 'auto' ? (osMedia && osMedia.matches ? 'dark' : 'light') : s;

        function paint(state) {
          const eff = effective(state);
          document.documentElement.setAttribute('data-theme', eff);
          try { localStorage.setItem(KEY, state); } catch (_) {}
          icons.forEach(el => el.innerHTML = state === 'auto' ? SYSTEM : (eff === 'dark' ? SUN : MOON));
          btns.forEach(el => {
            const t = 'Tema: ' + (state === 'auto' ? 'Sistema' : (state === 'dark' ? 'Escuro' : 'Claro'));
            el.title = t; el.setAttribute('aria-label', t);
          });
        }

        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (_) {}
        if (!saved) saved = 'auto';
        paint(saved);

        if (osMedia) {
          osMedia.addEventListener('change', () => {
            try {
              if ((localStorage.getItem(KEY) || 'auto') === 'auto') paint('auto');
            } catch (_) { paint('auto'); }
          });
        }

        btns.forEach(btn => btn.addEventListener('click', () => {
          let cur = 'auto';
          try { cur = localStorage.getItem(KEY) || 'auto'; } catch (_) {}
          paint(next(cur));
        }));
      })();
    </script>
  </body>
</html>
