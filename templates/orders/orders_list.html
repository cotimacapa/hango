{% extends "base.html" %}
{% load static %}
{% load tz %}

{% block title %}Pedidos â€” Hango{% endblock %}

{% block content %}
  <div class="block">
    <h1 class="title is-4">Pedidos ({{ day|date:"d/m/Y" }})</h1>
    <!-- <p class="subtitle is-6">Lista de supervisÃ£o. Para marcar retirada via leitor, use <strong class="has-text-weight-bold">Leitura de cÃ³digo</strong>.</p> -->
  </div>

  <div class="field is-grouped mb-4" style="gap:.75rem; flex-wrap:wrap;">
    <!-- Date picker + Go -->
    <div class="control">
      <form method="get" action="{% url 'orders:list' %}" class="field has-addons">
        <div class="control">
          <input class="input" type="date" name="day" value="{{ day|date:'Y-m-d' }}">
        </div>
        <div class="control">
          <button class="button is-link" type="submit">Ir</button>
        </div>
      </form>
    </div>

    <!-- Print sheet -->
    <div class="control">
      <a class="button" href="{% url 'orders:barcodes_print' %}?day={{ day|date:'Y-m-d' }}">ðŸ–¨ Imprimir cÃ³digos</a>
    </div>

    <!-- Export CSV -->
    <div class="control">
      <form method="get" action="{% url 'orders:export_csv' %}">
        <input type="hidden" name="day" value="{{ day|date:'Y-m-d' }}">
        <button class="button" type="submit">â¬‡ Exportar CSV</button>
      </form>
    </div>
  </div>

  <!-- ======================= MOBILE: STACKED ACCORDION ======================= -->
  <div class="is-hidden-tablet" data-role="orders-mobile-list">
    {% for o in orders %}
      <details class="box mb-3">
        <summary class="is-clickable" style="list-style:none;">
          <div class="is-flex is-justify-content-space-between is-align-items-center">
            <div class="mr-2">
              <strong>#{{ o.id }}</strong>
              <span class="ml-2">{{ o.user.get_full_name|default:o.user }}</span>
              <span class="ml-2 has-text-grey">({{ o.user.student_classes.first.name|default:"sem turma" }})</span>
            </div>
            <div>
              {% if o.status == "canceled" %}
                <span class="tag is-dark">Cancelado</span>
              {% elif o.status == "picked_up" %}
                <span class="tag is-success">Finalizado</span>
              {% elif o.status == "pending" %}
                <span class="tag is-warning">Pendente</span>
              {% else %}
                <span class="tag">{{ o.status }}</span>
              {% endif %}
            </div>
          </div>
        </summary>

        <div class="mt-3 content">
          <p><strong>Aluno:</strong> {{ o.user.get_full_name|default:o.user }}</p>
          <p><strong>Turma:</strong> {{ o.user.student_classes.first.name|default:"sem turma" }}</p>
          <p><strong>Token:</strong> <code>{{ o.pickup_token }}</code></p>
          <p><strong>Entrega:</strong>
            {% if o.delivered_at %}
              Entregue <span class="is-size-7 has-text-grey">({{ o.delivered_at|localtime|date:"d/m/Y H:i" }})</span>
            {% elif o.delivery_status == "undelivered" %}
              NÃ£o entregue
            {% else %}
              â€”
            {% endif %}
          </p>
          <p><strong>Criado:</strong> {{ o.created_at|localtime|date:"d/m/Y H:i" }}</p>
        </div>
      </details>
    {% empty %}
      <p class="has-text-grey">Nenhum pedido para a data selecionada.</p>
    {% endfor %}
  </div>

  <!-- ======================= DESKTOP: TABLE ======================= -->
  <div class="table-container is-hidden-mobile">
    <table class="table is-fullwidth is-striped is-hoverable">
      <thead>
        <tr>
          <th>#</th>
          <th>
            <a href="?day={{ day|date:'Y-m-d' }}&sort={% if sort == 'name' %}-name{% else %}name{% endif %}">
              Aluno{% if sort == 'name' %} â–²{% elif sort == '-name' %} â–¼{% endif %}
            </a>
          </th>
          <th>
            <a href="?day={{ day|date:'Y-m-d' }}&sort={% if sort == 'class' %}-class{% else %}class{% endif %}">
              Turma{% if sort == 'class' %} â–²{% elif sort == '-class' %} â–¼{% endif %}
            </a>
          </th>
          <th>Token</th>
          <th>Status</th>
          <th>Entrega</th>
          <th>Criado</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
          <tr>
            <td>{{ o.id }}</td>
            <td>{{ o.user.get_full_name|default:o.user }}</td>
            <td>{{ o.user.student_classes.first.name|default:"sem turma" }}</td>
            <td><code>{{ o.pickup_token }}</code></td>
            <td>
              {% if o.status == "canceled" %}
                <span class="tag is-dark">Cancelado</span>
              {% elif o.status == "picked_up" %}
                <span class="tag is-success">Finalizado</span>
              {% elif o.status == "pending" %}
                <span class="tag is-warning">Pendente</span>
              {% else %}
                <span class="tag">{{ o.status }}</span>
              {% endif %}
            </td>
            <td>
              {% if o.delivered_at %}
                <span class="tag is-success is-light">Entregue</span>
                <span class="is-size-7 has-text-grey"> {{ o.delivered_at|localtime|date:"d/m/Y H:i" }}</span>
              {% elif o.delivery_status == "undelivered" %}
                <span class="tag is-danger is-light">NÃ£o entregue</span>
              {% else %}
                â€”
              {% endif %}
            </td>
            <td class="has-text-grey">{{ o.created_at|localtime|date:"d/m/Y H:i" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="has-text-grey">Nenhum pedido para a data selecionada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
