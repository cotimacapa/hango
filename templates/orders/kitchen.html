{% extends 'base.html' %}
{% load static i18n %}
{% load i18n %}
{% block title %}{% trans "Kitchen Board" %} - Hango{% endblock %}
{% block content %}

<!-- Auto-refresh every 10s -->
<script>setTimeout(function(){ location.reload(); }, 10000);</script>

<h1 class="title">{% trans "Kitchen Board" %}</h1>
<p class="subtitle">{% trans "Today’s orders. Auto-refreshing every 10 seconds." %}</p>

<div class="box">
  {% if orders %}
  <table class="table is-fullwidth">
    <thead>
      <tr>
        <th>ID</th>
        <th>{% trans "When" %}</th>
        <th>{% trans "Student" %}</th>
        <th>{% trans "Items" %}</th>
        <th>{% trans "Pickup" %}</th>
        <th>{% trans "Notes" %}</th>
        <th>{% trans "Status" %}</th>
        <th>{% trans "Delivery" %}</th>
        <th class="has-text-right">{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td>#{{ o.id }}</td>
        <td title="{{ o.created_at }}">{{ o.created_at|timesince }} ago</td>
        <td>{{ o.user }}</td>
        <td>
          {% for li in o.lines.all %}
            <span class="tag is-light mb-1">{{ li.qty }}× {{ li.item.name }}</span>
          {% empty %}-{% endfor %}
        </td>
        <td>{% if o.pickup_slot %}{{ o.pickup_slot|date:"H:i" }}{% else %}-{% endif %}</td>
        <td>{{ o.notes|default:"" }}</td>
        <td>
          <span class="tag
            {% if o.status == 'pending' %}is-warning{% elif o.status == 'preparing' %}is-info
            {% elif o.status == 'ready' %}is-primary{% elif o.status == 'picked_up' %}is-success
            {% elif o.status == 'canceled' %}is-danger{% else %}is-light{% endif %}">
            {{ o.get_status_display }}
          </span>
        </td>
        <td>
          {% if o.delivery_status == 'delivered' %}
            <span class="tag is-success">{% trans "Delivered" %}</span>
          {% else %}
            <span class="tag is-warning">{% trans "Pending" %}</span>
          {% endif %}
        </td>
        <td class="has-text-right">
          {% if request.user.is_staff %}
            <div class="buttons are-small is-right">
              <!-- Green ✓ = delivered -->
              <form method="post" action="{% url 'orders:deliver' o.id 'delivered' %}" style="display:inline">
                {% csrf_token %}
                <button type="submit" class="button is-success" title="{% trans 'Mark delivered' %}">✓</button>
              </form>
              <!-- Red ✕ = pending / not delivered -->
              <form method="post" action="{% url 'orders:deliver' o.id 'pending' %}" style="display:inline">
                {% csrf_token %}
                <button type="submit" class="button is-danger" title="{% trans 'Mark not delivered' %}">✕</button>
              </form>
            </div>
          {% else %}
            <span class="has-text-grey">—</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>{% trans "No orders so far." %}</p>
  {% endif %}
</div>
{% endblock %}
