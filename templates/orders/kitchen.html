{% extends 'base.html' %}
{% load static %}
{% block title %}Cozinha - Hango{% endblock %}
{% block content %}

<!-- Atualiza automaticamente a cada 10s -->
<!-- <script>setTimeout(function(){ location.reload(); }, 10000);</script> -->

<h1 class="title">Cozinha</h1>
<p class="subtitle">Pedidos pendentes de hoje.</p>

<div class="field is-grouped mb-4" style="gap:.75rem; flex-wrap:wrap;">
  <p class="control">
    <a class="button is-link" href="{% url 'orders:scan' %}">ðŸ”Ž Leitura de cÃ³digo</a>
  </p>
</div>

<!-- <form method="get" class="field is-grouped is-flex-wrap-wrap mb-4" style="gap:.75rem;">
  <div class="control">
    <input class="input" type="text" name="nome" placeholder="Filtrar por nome"
           value="{{ nome_filtro }}">
  </div>
  <div class="control">
    <input class="input" type="text" name="turma" placeholder="Filtrar por turma"
           value="{{ turma_filtro }}">
  </div>
  <div class="control">
    <button class="button is-link" type="submit">Filtrar</button>
  </div>
</form> -->

<div class="box">
  {% if orders %}
    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Quando</th>
            <th>
              <a href="?{% if nome_filtro %}nome={{ nome_filtro }}&{% endif %}{% if turma_filtro %}turma={{ turma_filtro }}&{% endif %}sort={% if sort_param == 'nome' %}-nome{% else %}nome{% endif %}">
                Aluno {% if sort_param == "nome" %}â–²{% elif sort_param == "-nome" %}â–¼{% endif %}
              </a>
            </th>
            <th>
              <a href="?{% if nome_filtro %}nome={{ nome_filtro }}&{% endif %}{% if turma_filtro %}turma={{ turma_filtro }}&{% endif %}sort={% if sort_param == 'turma' %}-turma{% else %}turma{% endif %}">
                Turma {% if sort_param == "turma" %}â–²{% elif sort_param == "-turma" %}â–¼{% endif %}
              </a>
            </th>
            <th>Itens</th>
            <th class="has-text-right">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
            <tr>
              <td>#{{ o.id }}</td>
              <td title="{{ o.created_at }}">{{ o.created_at|timesince }} atrÃ¡s</td>
              <td>{{ o.user.get_full_name|default:o.user.username }}</td>
              <td>{{ o.user.student_classes.first.name|default:"â€”" }}</td>
              <td>
                {% for li in o.lines.all %}
                  <span class="tag is-light mb-1">{{ li.qty }}Ã— {{ li.item.name }}</span>
                {% empty %}
                  <span class="has-text-grey">â€”</span>
                {% endfor %}
              </td>
              <td class="has-text-right">
                {% if request.user.is_staff %}
                  <div class="buttons are-small is-right">
                    <!-- Verde âœ“ = Entregue -->
                    <form method="post" action="{% url 'orders:deliver' o.id 'delivered' %}" class="is-inline-block">
                      {% csrf_token %}
                      <button type="submit" class="button is-success"
                              title="Marcar como entregue"
                              aria-label="Marcar como entregue">
                        âœ“ Entregue
                      </button>
                    </form>
                    <!-- Amarelo âš  = NÃ£o Entregue -->
                    <form method="post" action="{% url 'orders:deliver' o.id 'undelivered' %}" class="is-inline-block ml-2">
                      {% csrf_token %}
                      <button type="submit" class="button is-warning"
                              title="Marcar como nÃ£o entregue"
                              aria-label="Marcar como nÃ£o entregue">
                        âš  NÃ£o Entregue
                      </button>
                    </form>
                  </div>
                {% else %}
                  <span class="has-text-grey">â€”</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="has-text-grey">Nenhum pedido pendente para hoje.</p>
  {% endif %}
</div>

<div class="buttons">
  <a class="button" href="{% url 'orders:list' %}">
    Ir para Pedidos (hoje)
  </a>
</div>

{% endblock %}
