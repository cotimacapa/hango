{% extends 'base.html' %}
{% load static %}
{% block title %}Cozinha - Hango{% endblock %}
{% block content %}

<!-- Atualiza automaticamente a cada 10s -->
<script>setTimeout(function(){ location.reload(); }, 10000);</script>

<h1 class="title">Cozinha</h1>
<p class="subtitle">Pedidos pendentes de hoje. Atualiza automaticamente a cada 10 segundos.</p>

<div class="box">
  {% if orders %}
    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Quando</th>
            <th>Aluno</th>
            <th>Itens</th>
            <th class="has-text-right">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
            <tr>
              <td>#{{ o.id }}</td>
              <td title="{{ o.created_at }}">{{ o.created_at|timesince }} atrás</td>
              <td>{{ o.user.get_full_name|default:o.user.username }}</td>
              <td>
                {% for li in o.lines.all %}
                  <span class="tag is-light mb-1">{{ li.qty }}× {{ li.item.name }}</span>
                {% empty %}
                  <span class="has-text-grey">—</span>
                {% endfor %}
              </td>
              <td class="has-text-right">
                {% if request.user.is_staff %}
                  <div class="buttons are-small is-right">
                    <!-- Verde ✓ = Entregue -->
                    <form method="post" action="{% url 'orders:deliver' o.id 'delivered' %}" class="is-inline-block">
                      {% csrf_token %}
                      <button type="submit" class="button is-success"
                              title="Marcar como entregue"
                              aria-label="Marcar como entregue">
                        ✓ Entregue
                      </button>
                    </form>
                    <!-- Amarelo ⚠ = Não Entregue -->
                    <form method="post" action="{% url 'orders:deliver' o.id 'undelivered' %}" class="is-inline-block ml-2">
                      {% csrf_token %}
                      <button type="submit" class="button is-warning"
                              title="Marcar como não entregue"
                              aria-label="Marcar como não entregue">
                        ⚠ Não Entregue
                      </button>
                    </form>
                  </div>
                {% else %}
                  <span class="has-text-grey">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="has-text-grey">Nenhum pedido pendente para hoje.</p>
  {% endif %}
</div>

<div class="buttons">
  <a class="button" href="{% url 'orders:list' %}">
    Ir para Pedidos (hoje)
  </a>
</div>

{% endblock %}
